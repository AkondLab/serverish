# Main comcepts of the serverish helpers


## Paramterized
The serverish helpers are parameterized in the sense of deriving from `param.Parameterized` class.


## Tree structure
The serverish components are organizable in a tree structure. 
The `Manageable` class is responsible for the tree structure maintenance.

## Messenger
nats-based messenger

### Metadata
The metadata is sent with all the messages handled by the `Messenger`.
The python dict (json serialized) structure of the message is:
```python
{
    "data": {
        "user_keys":  "user_values",
        # ...
    },
    "meta": {
        "message_id": "message_id",  # autogenerated
        "sender": "sender_name",
        "receiver": "receiver_name",  # only for direct messages
        "timestamp": (2021, 1, 1, 0, 0, 0, 0, 0, 0),  # as time touple e.g. (2021, 1, 1, 0, 0, 0, 0, 0, 0)
        "trace_level": logging.DEBUG,  # Message trace will be logged if loglevel <= trace_level
        "message_type": "message_type",
        "tags": ["tag1", "tag2", ...],
    }
}
```

### Validation
The message is validated against the schema. 
Schema files for message data are located in `serverish/schemas/` directory.

The name corresponds to the `message_type` field of the message metadata.

Metadata schema is hardcoded in the `MetaValidator` class.

### Specialized publishers and readers

Usually, one have to ensure opening and closing messenger properly. 
Then all communication is done via specialized classes maintaining connection on single subject.

All those classes derive from `MsgDriver` class. 
There are convenient methods and functions for obtaining those classes instances in the `Messenger` class.

Lookup the table below to choose the right class for your needs.

| Publish class           | Read class              | Functions                                                               | Description and use-cases                                                                                                                                                                                                                                       |
|-------------------------|-------------------------|-------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `MsgPublisher`          | `MsgReader`             | `get_publisher` `get_reader`                                            | The most general classes. Suitable for publishing / reading multiple messages. For reader it can be used for existing and future messages. It creates pull-consumer for existing messages and automatically switches to push consumer waiting for new messages. |
|                         | `MsgCallbackSubscriber` | `get_callbacksubscriber`                                                | Use this class insted of `MsgReader` if you prefer callback oriented approach rather than (recommended) iteration using `MsgReader`.                                                                                                                            |
| `MsgSinglePublisher`    | `MsgSingleReader`       | `get_singlepublisher` `get_singlereader` `single_publish` `single_read` | The classes and methods to publish and read single value. The usecase is e.g. distribution of the config settings dictionary.                                                                                                                                   |
| `MsgRpcRequester`       | `MsgRpcResponder`       | `get_rpcrequester` `request` `get_rpcresponder`                         | The RPC - Request/Response classes. As an exception, do not use JetStream subject here.                                                                                                                                                                         |
| `MsgProgressPublisher`  | `MsgProgressReader`     | `get_progresspublisher` `get_progressreader`                            | The classes for remote progress tracking                                                                                                                                                                                                                        |
